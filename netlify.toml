[build]
  command = "node fix-bcrypt-netlify.js && node netlify-build.js"
  publish = ".next"

[build.environment]
  NODE_VERSION = "18.18.0"
  NETLIFY_NEXT_PLUGIN_SKIP = "true"
  # Disable Prisma's automatic generation to fix caching issues
  PRISMA_SKIP_POSTINSTALL_GENERATE = "true"
  # Disable sourcemaps processing
  NEXT_DISABLE_SOURCEMAPS = "true"
  # Force standard shell to avoid any 'mise' or custom shell issues
  SHELL = "/bin/bash"
  # Use standard npm flags
  NPM_FLAGS = "--no-audit --no-fund"

# Define specific prebuild step for bcrypt
[build.lifecycle]
  onPreBuild = "npm rebuild bcrypt --build-from-source"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[[plugins]]
  package = "netlify-plugin-cache-nextjs"

# Custom local plugin to fix missing files
[[plugins]]
  package = "./netlify-nextjs-fix-plugin"

# Remove the redirect as it might interfere with Next.js routing
# [[redirects]]
#   from = "/*"
#   to = "/index.html"
#   status = 200
#   force = false 